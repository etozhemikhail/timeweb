pipeline {
    agent any

    environment {
        GIT_CREDENTIALS_ID = 'your-credentials-id'
        GIT_BRANCH = 'main'
        HELMS_DIR = 'helms'
    }

    parameters {
        string(name: 'nexusArchiveUrl', defaultValue: '', description: 'Link to Nexus archive')
        string(name: 'gitRepositoryUrl', defaultValue: '', description: 'Git repository URL')
    }

    stages {
        stage('Checkout and Generate parameters') {
            steps {
                git {
                    remote {
                        url("${gitRepositoryUrl}")
                        credentialsId(env.GIT_CREDENTIALS_ID)
                    }
                    branch(env.GIT_BRANCH)
                }
                script {
                    def params = [:]
                    def dirs = findFiles(glob: "${HELMS_DIR}/**/").collect { it.name }
                    dirs.each { dir ->
                        def appName = dir
                        params["url-${appName}"] = [string(name: "url-${appName}", defaultValue: '', description: "URL for ${appName}")]
                        params["deploy-url-${appName}"] = [booleanParam(name: "deploy-url-${appName}", defaultValue: false, description: "Deploy ${appName}?")]
                    }
                    params['nexusArchiveUrl'] = [string(name: 'nexusArchiveUrl', defaultValue: '', description: 'Link to Nexus archive')]
                    pipelineParameters(params)
                }
            }
        }
    }
}