pipeline {
    agent any

    environment {
        GIT_CREDENTIALS_ID = 'your-credentials-id'
        HELMS_DIR = 'helms'
    }

    parameters {
        string(name: 'nexusArchiveUrl', defaultValue: '', description: 'Link to Nexus archive')
    }

    stages {
        stage('Checkout and Generate parameters') {
            steps {
                checkout scm
                def appDirectories = findFiles(glob: "${HELMS_DIR}/**/").collect { it.getFile().getParent().getName() }.unique()
                def params = appDirectories.collect { dir ->
                    [
                        "url-${dir}": '',
                        "deploy-url-${dir}": false
                    ]
                }.flatten() + ['nexusArchiveUrl': '']
                properties([
                    parameters(params.collect { k, v ->
                        if (k.startsWith('url-')) {
                            string(name: k, defaultValue: v, description: "URL for ${k - 'url-'}")
                        } else if (k.startsWith('deploy-url-')) {
                            booleanParam(name: k, defaultValue: v, description: "Deploy ${k - 'deploy-url-'}?")
                        } else {
                            string(name: k, defaultValue: v, description: 'Link to Nexus archive')
                        }
                    })
                ])
            }
        }
    }
}