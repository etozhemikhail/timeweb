pipeline {
    agent any

    environment {
        GIT_CREDENTIALS_ID = 'your-credentials-id'
        HELMS_DIR = 'helms'
    }

    stages {
        stage('Checkout and Generate parameters') {
            steps {
                script {
                    checkout scm
                    // Находим все файлы и директории
                    def allFiles = findFiles(glob: "${HELMS_DIR}/**/*")
                    
                    // Фильтруем только директории
                    def appDirectories = allFiles.findAll { it.directory }.collect { it.name }.unique()

                    // Динамическое создание параметров
                    def params = appDirectories.collect { dir ->
                        [
                            string(name: "url-${dir}", defaultValue: '', description: "URL for ${dir}"),
                            booleanParam(name: "deploy-url-${dir}", defaultValue: false, description: "Deploy ${dir}?")
                        ]
                    }.flatten()

                    // Добавление nexusArchiveUrl, если его нет среди appDirectories
                    if (!appDirectories.contains('nexusArchiveUrl')) {
                        params << string(name: 'nexusArchiveUrl', defaultValue: '', description: 'Link to Nexus archive')
                    }

                    // Применение параметров
                    properties([
                        parameters(params)
                    ])
                }
            }
        }
    }
}